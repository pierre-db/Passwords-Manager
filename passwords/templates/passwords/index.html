<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1">

        <title>Memento</title>

        <style>
            body{
                font-family:Arial, sherif;
                background-color:#FFFFFF;
                font-size:small;
                color:#020202;
            }

            a{
                text-decoration: none;
                color: #020202;
                transition: color .3s;
                -moz-transition: color .3s; /* Firefox 4 */
                -webkit-transition: color .3s; /* Safari and Chrome */
                -o-transition: color .3s; /* Opera */
            }
            a:hover, a.selected{
                color: #ea4848;
            }

            table{
                border-spacing: 0;
                border-collapse: collapse;
                display:inline-block;
            }

            h1{
                font-size:large;
                margin-bottom:20px;
            }

            input{
                width:100%;
                max-width:300px;
                box-sizing: border-box;
                height:24px;
                border:none;
                border-bottom:1px solid #E8E8E8;
                border-radius: 2px;
            }
            input:focus {
                outline:none;
                border-bottom:2px solid #909090;
            }
            input.btn{
                border:none;
                padding-bottom:1px;
                padding-top:1px;
            }

            span#suggestion{
                display: block;
                height:20px;
                box-sizing: border-box;
                background-color:#F5F5F5;
                padding-top:8px;
                padding-bottom:24px;
                border:none;
            }
            span#suggestion:hover{
                background: #E8E8E8;
            }
            #suggestions{
                text-align:left;
                width:100%;
                margin-top:0px;
                max-width:300px;
                max-height:98px;
                overflow-y:scroll;
                overflow-x:hidden;
                display:none;
            }

            #output{
                text-align:left;
                margin-top:10px;
            }

            #wrapper{
                position:fixed;
                top:0;
                left:0;
                right:0;
                text-align:center;
            }

            #wrapper > div{
                display:inline-block;
                margin-top:10px;

                text-align:center;

                background-color:#F2F2F2;

                padding-top:10px;
                padding-bottom:10px;
                padding-left:20px;
                padding-right:20px;

                box-shadow: 2px 2px 6px #CECECE;
                -moz-border-radius: 10x;
                -webkit-border-radius: 10px;
                border-radius: 10px;
            }

            .select{
                width:70%;
                height:150px;
            }

            .select > p{
                text-align:right;
                margin-top:-5px;
            }
        </style>

        <script type="text/javascript">
            var list = [{% for category in categories %}"{{ category }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
        </script>
        <script type="text/javascript">
            // Password manager JavaScript - converted from original main.js

            // Empties an element
            function emptyElement(elt) {
                while(elt.lastChild)
                    elt.removeChild(elt.lastChild);
            }

            // Fills an element with HTML content
            function fillElement(elt, str) {
                elt.innerHTML = str;
            }

            // Selects all text in input (modern browsers)
            function selectChars(input) {
                input.focus();
                input.select();
            }

            // Modern normalize function for accented characters
            function normalizeString(str) {
                return str
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, ''); // Remove diacritics
            }

            // Select a service from suggestions
            function selectService(index) {
                const input = document.querySelector('input[name="input"]');
                input.value = list[index];
                handleSearch(index);
            }

            // Main search function - simplified and modernized
            function handleSearch(serviceIndex = -1) {
                const input = document.querySelector('input[name="input"]').value.trim();
                const suggestionsEl = document.getElementById("suggestions");
                const outputEl = document.getElementById("output");

                // Clear previous results
                suggestionsEl.innerHTML = '';
                suggestionsEl.style.display = 'none';
                outputEl.innerHTML = '';

                if (!input) return;

                // If specific service index provided, fetch that service
                if (serviceIndex >= 0) {
                    sendRequest(serviceIndex);
                    return;
                }

                // Find exact match first
                const exactMatch = list.findIndex(service =>
                    normalizeString(service) === normalizeString(input)
                );

                if (exactMatch >= 0) {
                    sendRequest(exactMatch);
                    return;
                }

                // Show suggestions for partial matches
                const suggestions = list
                    .map((service, index) => ({ service, index }))
                    .filter(({ service }) =>
                        normalizeString(service).startsWith(normalizeString(input))
                    )
                    .sort((a, b) => a.service.localeCompare(b.service))
                    .slice(0, 6); // Limit to 6 suggestions

                if (suggestions.length > 0) {
                    suggestions.forEach(({ service, index }) => {
                        const suggestionEl = document.createElement("span");
                        suggestionEl.id = "suggestion";
                        suggestionEl.textContent = service;
                        suggestionEl.addEventListener('click', () => selectService(index));
                        suggestionsEl.appendChild(suggestionEl);
                    });
                    suggestionsEl.style.display = 'inline-block';
                }
            }

            async function sendRequest(data) {
                const outputElement = document.getElementById("output");

                // Show loading message
                fillElement(outputElement, "Recupération des données...");

                try {
                    const response = await fetch("{% url 'fetch_data' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": getCookie('csrftoken')
                        },
                        body: "item=" + data
                    });

                    if (response.ok) {
                        const output = await response.text();
                        fillElement(outputElement, output.trim());
                    } else {
                        fillElement(outputElement, "Erreur lors de la récupération des données");
                    }
                } catch (error) {
                    fillElement(outputElement, "Erreur lors de la récupération des données");
                }
            }

            // Get CSRF token for Django
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        </script>
    </head>
    <body>
        <div id="wrapper">
            <div class="select">
                <p><a href="{% url 'logout' %}">Déconnecter</a></p>
                <h1>Memento</h1>

                <form name="search" onsubmit="return false;">
                    <input type="text" name="input" autocomplete="off" placeholder="Entrez un mot" oninput="handleSearch()" onfocus="selectChars(this)"/>
                </form>
                <div id="suggestions"></div>
                <div id="output"> </div>
            </div>
        </div>
    </body>
</html>